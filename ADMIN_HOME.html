<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TRACE - Tactical Real-Time Analysis of Criminal Events</title>
  <link rel="icon" href="your_emblem_here.png" type="image/png">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
       :root {
      --primary-color: #0a1931;
      --accent-color: #f0c808;
      --text-color: #ffffff;
      --background-color: #ffffff;
      --dark-background: #0a1931;
      --dark-card: #13274f;
      --dark-text: #f0f0f0;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--background-color);
      color: var(--primary-color);
      transition: background-color 0.5s, color 0.5s;
      scroll-behavior: smooth;
    }
    .top-bar, .main-bar, .nav-bar, .dashboard, .dashboard-card, .info-section {
      transition: background-color 0.5s, color 0.5s;
    }
    .top-bar, .main-bar, .nav-bar {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .dashboard {
      padding: 30px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      background-color: #f7f7f7;
    }
    .dashboard-card, .info-section {
      background: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .header {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.time-display {
  font-family: Arial, sans-serif;
  font-size: 14px;
  color: #333;
  padding-right: 20px;
}


    .top-bar {
      background-color: #ffffff;
      font-size: 0.9rem;
      border-bottom: 1px solid lightgrey;
    }
    .top-bar div {
      display: flex;
      align-items: center;
    }
    .vertical-line {
      border-left: 1px solid grey;
      height: 15px;
      margin: 0 10px;
    }
    .main-bar {
      background-color: #ffffff;
      border-bottom: 1px solid lightgrey;
    }
    .main-bar img {
      height: 50px;
      margin-right: 15px;
    }
    .main-bar-title {
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--primary-color);
    }
    .main-bar-buttons button {
      margin-left: 15px;
      padding: 8px 15px;
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .main-bar-buttons button:hover {
      background-color: var(--accent-color);
      color: var(--primary-color);
    }
    .nav-bar {
      background-color: var(--primary-color);
    }
    .nav-links a {
      color: var(--text-color);
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    .search-bar input {
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      margin-left: 20px;
    }
    select {
      margin-top: 10px;
      padding: 8px 15px;
      font-size: 1rem;
      border-radius: 5px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      transition: background-color 0.5s, color 0.5s;
    }
    footer {
      background-color: var(--primary-color);
      color: var(--text-color);
      text-align: center;
      padding: 15px;
      font-size: 0.9rem;
    }
    
    .crime-map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    .crime-records-section {
  background-color: #f4f4f4; /* Light background for the section */
  padding: 20px;
  margin: 20px 0;
  border-radius: 8px; /* Rounded corners for the section */
}

.dashboard-card {
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.dashboard-card h2 {
  font-size: 24px;
  color: #333;
}

.dashboard-card p {
  font-size: 16px;
  color: #666;
}

.dashboard-card select {
  padding: 10px;
  width: 100%;
  font-size: 16px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 10px;
}
.crime-log {
  height: 300px;
  overflow-y: auto;
  background-color: white;
  padding: 10px;
  border-left: 3px solid white;
  color: black;
  font-family: 'Poppins', sans-serif;
}

.crime-entry {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
}

.crime-entry i {
  margin-right: 8px;
}

.timestamp {
  color: black;
  margin-right: 8px;
}

/* Dashboard Container */
.dashboard-container {
  padding: 20px;
  background-color: #f4f4f4;
}

/* User Profile Header */
.profile-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  margin-bottom: 20px;
}

.user-logo {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-right: 20px;
}

.user-details {
  font-size: 18px;
}

/* Current Tasks Section */
.current-tasks {
  margin-bottom: 20px;
}

.current-tasks ul {
  list-style-type: none;
  padding: 0;
}

.current-tasks li {
  background-color: #fff;
  padding: 10px;
  margin-bottom: 5px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
}

/* Case Progress Graph */
.case-progress {
  margin-bottom: 20px;
}

/* Profile Details Section */
.profile-details {
  background-color: #fff;
  padding: 20px;
  border-radius: 5px;
}

#user-profile-details {
  width: 100%;
  border-collapse: collapse;
}

#user-profile-details td {
  padding: 8px;
  border: 1px solid #ddd;
}

.header {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.time-display {
  font-family: Arial, sans-serif;
  font-size: 14px;
  color: #333;
  margin-right: 10px; /* Adds spacing between time and toggle button */
}

.toggle-btn {
  font-size: 10px;
  padding: 5px 10px;
  background-color: transparent;
  border: 1px solid #333;
  cursor: pointer;
  transition: background-color 0.3s;
}

.toggle-btn:hover {
  background-color: #ddd;
}

.dashboard-container {
  background-color: #f4f4f4;
  padding: 30px;
  min-height: calc(100vh - 155px); /* Adjust based on your header/footer height */
  box-sizing: border-box;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.profile-header {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3 Columns */
  grid-template-rows: auto;
  gap: 20px;
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 1200px;
}

.user-logo {
  grid-column: span 3; /* Full-width */
  width: 150px;
  height: 150px;
  border-radius: 50%;
  object-fit: cover;
  margin: 0 auto 20px auto;
}

.user-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  width: 100%;
}

.user-details p {
  background-color: #fafafa;
  padding: 15px;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  font-size: 0.95rem;
  color: #333;
  margin: 0;
}

.user-details h3 {
  grid-column: span 3; /* Full-width */
  text-align: center;
  margin-bottom: 20px;
}
/* SEARCH BAR STYLES */
.search-container {
  display: flex;
  align-items: center;
  margin-left: 20px;
}

.search-bar {
  display: flex;
  align-items: center;
  background: white;
  border-radius: 5px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.search-bar input {
  padding: 8px 15px;
  border: none;
  outline: none;
  width: 200px;
  font-size: 14px;
}

.search-bar button {
  padding: 8px 12px;
  border: none;
  background: #f0c808;
  color: #0a1931;
  cursor: pointer;
  transition: background 0.3s;
}

.search-bar button:hover {
  background: #e0b700;
}

.search-results {
  position: absolute;
  top: 100%;
  right: 20px;
  width: 300px;
  max-height: 400px;
  overflow-y: auto;
  background: white;
  border-radius: 5px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  z-index: 1000;
  display: none;
  margin-top: 5px;
}

.search-result-item {
  padding: 10px 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.search-result-item:hover {
  background: #f5f5f5;
}

.search-result-item h4 {
  margin: 0 0 5px 0;
  color: #0a1931;
}

.search-result-item p {
  margin: 0;
  color: #666;
  font-size: 13px;
}

.highlight {
  background-color: yellow;
  color: black;
  padding: 0 2px;
}

.no-results {
  padding: 15px;
  text-align: center;
  color: #666;
}

.clear-search {
  display: block;
  width: 100%;
  padding: 8px;
  background: #f0f0f0;
  border: none;
  border-top: 1px solid #eee;
  cursor: pointer;
  text-align: center;
  color: #0a1931;
}

.clear-search:hover {
  background: #e0e0e0;
}
</style>



</head>

<body>

<!-- Top Bar -->
<div class="top-bar">
  <div>
    <span>Government of India</span>
    <div class="vertical-line"></div>
    <span>Ministry of Home Affairs</span>
  </div>
  
</div>

<div class="header">
  <div class="time-display" id="timeDisplay"></div>
 
</div>


<!-- Main Bar -->
<div class="main-bar">
  <div style="display:flex; align-items:center;">
    <img src="Picture1.png" alt="Main Logo">
    <span class="main-bar-title">TACTICAL REAL TIME ANALYSIS OF CRIMINAL EVENTS</span>
  </div>
  <div class="main-bar-buttons">
    <a href="CRIME_RECORDS.html"><button>Crime Records</button></a>
    <a href="NEW_CASE.html"><button>Add New Case</button></a>
    <a href="FORENSICS.html"><button>Forensics</button></a>
    <a href="BALLISTICS.html"><button>Ballistics</button></a>
    <a href="index.html"><button>Logout</button></a>
    <a href="HELPDESK.html"><button>Help Desk</button></a>
    
</div>

  </div>
</div>

<!-- Nav Bar -->
<div class="nav-bar">
  <div class="nav-links">
    <a href="#">Home</a>
    
    <a href="about.html">About</a>
    
  </div>
  <div class="search-container">
  <div class="search-bar">
    <input type="text" id="globalSearchInput" placeholder="Search">
    <button id="searchButton">
      <i class="fas fa-search"></i>
    </button>
  </div>
  <div class="search-results" id="searchResults">
    <!-- Results will appear here -->
  </div>
</div>
</div>

<div id="user-dashboard" class="dashboard-container">
  <div class="profile-header">
    
    <!-- User Profile Picture -->
    <img src="PROFILE.avif" alt="User Logo" class="user-logo">
    
    <!-- Full Name as Title -->
    <h3 id="user-name">Loading...</h3>

    <!-- User Details Grid -->
    <div class="user-details">
      <p>ID: <span id="user-id">Loading...</span></p>
      <p>Badge ID: <span id="user-badge">Loading...</span></p>
      <p>Full Name: <span id="user-fullname">Loading...</span></p>
      <p>Email: <span id="user-email">Loading...</span></p>
      <p>Date of Birth: <span id="user-dob">Loading...</span></p>
      <p>Sex: <span id="user-sex">Loading...</span></p>
      <p>Position: <span id="user-position">Loading...</span></p>
      <p>Department: <span id="user-department">Loading...</span></p>
      <p>Commissioned By: <span id="user-commissioned">Loading...</span></p>
      <p>Joining Date: <span id="user-joining">Loading...</span></p>
      <p>Mobile No: <span id="user-mobile">Loading...</span></p>
      <p>Address: <span id="user-address">Loading...</span></p>
    </div>
  </div>
</div>

  
    </ul>
  </div>

  <div class="case-progress">
    
  </div>

  <div class="">
    
    <table id="">
      
      <!-- Add additional personal details -->
    </table>
  </div>
</div>



<section class="crime-records-section">
  <div class="dashboard-card">
    <h2>State-Wise Crime Records</h2>
    <p>Select a state to view detailed crime data in a heat map or bar chart format:</p>
    <select onchange="redirectToStatePage(this.value)">
      <option value="">-- Select State --</option>
      <option value="andhra-pradesh">Andhra Pradesh</option>
      <option value="arunachal-pradesh">Arunachal Pradesh</option>
      <option value="assam">Assam</option>
      <option value="bihar">Bihar</option>
      <option value="chhattisgarh">Chhattisgarh</option>
      <option value="goa">Goa</option>
      <option value="gujarat">Gujarat</option>
      <option value="haryana">Haryana</option>
      <option value="himachal-pradesh">Himachal Pradesh</option>
      <option value="jharkhand">Jharkhand</option>
      <option value="karnataka">Karnataka</option>
      <option value="kerala">Kerala</option>
      <option value="madhya-pradesh">Madhya Pradesh</option>
      <option value="maharashtra">Maharashtra</option>
      <option value="manipur">Manipur</option>
      <option value="meghalaya">Meghalaya</option>
      <option value="mizoram">Mizoram</option>
      <option value="nagaland">Nagaland</option>
      <option value="odisha">Odisha</option>
      <option value="punjab">Punjab</option>
      <option value="rajasthan">Rajasthan</option>
      <option value="sikkim">Sikkim</option>
      <option value="tamil-nadu">Tamil Nadu</option>
      <option value="telangana">Telangana</option>
      <option value="tripura">Tripura</option>
      <option value="uttar-pradesh">Uttar Pradesh</option>
      <option value="uttarakhand">Uttarakhand</option>
      <option value="west-bengal">West Bengal</option>
    </select>
  </div>
</section>

<script>
  function redirectToStatePage(state) {
    if (state) {
      // Redirect to a page with the state's data
      window.location.href = `state_crime_report.html?state=${state}`;
    } else {
      alert("Please select a state.");
    }
  }
</script>



<!-- NATIONAL CRIME MAP SECTION -->
<section class="info-section">
  <h2>National Crime Map</h2>
  <p>Below is the crime distribution across India, showcasing crime hotspots and crime rate per state:</p>
  <!-- National Crime Map -->
  <div id="national-crime-map" class="crime-map"></div>
</section>

<!-- DASHBOARD SECTION -->
<section class="dashboard">
  <div class="dashboard-card">
    <h2>Crime Analysis </h2>
    <canvas id="crimeChart" width="400" height="200"></canvas>
  </div>

  <div class="dashboard-card">
    <h2>Live Crime Tracking</h2>
    <p>Tracking crimes in real-time. Updates every few seconds.</p>
    <!-- Placeholder for live crime map -->
    <div id="live-crime-map" class="crime-map"></div>
  </div>

  <div class="dashboard-card">
    <div class="dashboard-card">
      <h2>Live Crime Log</h2>
      <div id="crime-log" class="crime-log">
        <!-- Crimes will appear here dynamically -->
      </div>
    </div>
    
</section>

<!-- FOOTER -->
<footer>
  Â© 2025 TRACE | Ministry of Home Affairs | All Activities are Monitored and Secured.
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {  
    apiKey: "AIzaSyC1bCHfPCiBpLXNdLev0TMkGGuAkqQywbQ",
    authDomain: "trace-601a4.firebaseapp.com",
    projectId: "trace-601a4",
    storageBucket: "trace-601a4.appspot.com",
    messagingSenderId: "492652025922",
    appId: "1:492652025922:web:935b8e7efe06be845ab5db",
    measurementId: "G-89T9DRMKZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      console.warn("User not logged in. Redirecting...");
      window.location.href = "TRACE_LOGIN.html";
      return;
    }

    console.log("âœ… User signed in:", user.uid);

    // Fill basic fields
    document.getElementById("user-name").innerText = user.displayName || user.email || "â€”";
    document.getElementById("user-email").innerText = user.email || "â€”";
    document.getElementById("user-id").innerText = user.uid || "â€”";

    try {
      // First try to fetch from admins collection
      const adminDocRef = doc(db, "admins", user.uid);
      const adminDocSnap = await getDoc(adminDocRef);

      if (adminDocSnap.exists()) {
        const adminData = adminDocSnap.data();
        console.log("ðŸ“¦ Loaded Admin data:", adminData);

        // Populate admin fields
        document.getElementById("user-fullname").innerText     = `${adminData.firstName || ""} ${adminData.lastName || ""}`.trim();
        document.getElementById("user-badge").innerText        = adminData.badgeId        || adminData["badge.io"] || "â€”";
        document.getElementById("user-dob").innerText          = adminData.dob            || "â€”";
        document.getElementById("user-sex").innerText          = adminData.sex            || "â€”";
        document.getElementById("user-position").innerText     = adminData.position       || "â€”";
        document.getElementById("user-department").innerText   = adminData.department     || "â€”";
        document.getElementById("user-commissioned").innerText = adminData.commissionedBy || "â€”";
        document.getElementById("user-joining").innerText      = adminData.joiningDate    || "â€”";
        document.getElementById("user-mobile").innerText       = adminData.mobileNo       || "â€”";
        document.getElementById("user-address").innerText      = adminData.address        || "â€”";
        
        // Add admin-specific fields if needed
        document.getElementById("user-role").innerText        = adminData.role || "Admin";
        
        return;
      }

      // If not found in admins, try users collection
      const userDocRef = doc(db, "users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        console.log("ðŸ“¦ Loaded User data:", userData);

        // Populate user fields
        document.getElementById("user-fullname").innerText     = `${userData.firstName || ""} ${userData.lastName || ""}`.trim();
        document.getElementById("user-badge").innerText        = userData.badgeId        || "â€”";
        document.getElementById("user-dob").innerText          = userData.dob            || "â€”";
        document.getElementById("user-sex").innerText          = userData.sex            || "â€”";
        document.getElementById("user-position").innerText     = userData.position       || "â€”";
        document.getElementById("user-department").innerText   = userData.department     || "â€”";
        document.getElementById("user-commissioned").innerText = userData.commissionedBy || "â€”";
        document.getElementById("user-joining").innerText      = userData.joiningDate    || "â€”";
        document.getElementById("user-mobile").innerText       = userData.mobileNo       || "â€”";
        document.getElementById("user-address").innerText      = userData.address        || "â€”";
        
        return;
      }

      console.warn("âš ï¸ No user data found in either admins or users collection for:", user.uid);

    } catch (err) {
      console.error("âŒ Failed to fetch user profile:", err);
    }
  });

  // Crime chart initialization
function initializeCrimeChart() {
  const ctx = document.getElementById('crimeChart').getContext('2d');
  const crimeData = {
    labels: ['Robbery', 'Assault', 'Cybercrime', 'Murder', 'Theft', 'Fraud'],
    datasets: [{
      label: 'Number of Crimes',
      data: [120, 180, 150, 70, 210, 130],
      backgroundColor: '#ff9900',
      borderColor: '#ff6600',
      borderWidth: 1
    }]
  };

  return new Chart(ctx, {
    type: 'bar',
    data: crimeData,
    options: {
      responsive: true,
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: 'Types of Crime' }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Number of Crimes' }
        }
      }
    }
  });
}

// Initialize maps and crime tracking
function initializeMaps() {
  // Initialize Live Crime Map
  const liveCrimeMap = L.map('live-crime-map').setView([20.5937, 78.9629], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(liveCrimeMap);

  // Initialize National Crime Map
  const nationalCrimeMap = L.map('national-crime-map').setView([20.5937, 78.9629], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(nationalCrimeMap);

  return { liveCrimeMap, nationalCrimeMap };
}

// Custom colored icons for maps
function createMapIcons() {
  return {
    redIcon: new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    }),
    orangeIcon: new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    }),
    blueIcon: new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  };
}

// Add crime hotspots to the national map
function addCrimeHotspots(map, icons) {
  const crimeHotspots = [
    { lat: 28.6448, lng: 77.216721, location: 'Delhi', threatType: 'Robbery', description: 'Armed robbery reported near Connaught Place.', timestamp: new Date().toLocaleString() },
    { lat: 19.0760, lng: 72.8777, location: 'Mumbai', threatType: 'Cybercrime', description: 'Major phishing attack targeting banks.', timestamp: new Date().toLocaleString() },
    { lat: 13.0827, lng: 80.2707, location: 'Chennai', threatType: 'Assault', description: 'Physical assault reported in Marina Beach area.', timestamp: new Date().toLocaleString() },
    { lat: 22.5726, lng: 88.3639, location: 'Kolkata', threatType: 'Theft', description: 'Chain snatching incident in Park Street.', timestamp: new Date().toLocaleString() },
    { lat: 12.9716, lng: 77.5946, location: 'Bangalore', threatType: 'Murder', description: 'Homicide case under investigation near MG Road.', timestamp: new Date().toLocaleString() }
  ];

  crimeHotspots.forEach(hotspot => {
    let markerIcon = icons.blueIcon; // Default
    
    if (hotspot.threatType === 'Murder' || hotspot.threatType === 'Assault') {
      markerIcon = icons.redIcon;
    } else if (hotspot.threatType === 'Robbery' || hotspot.threatType === 'Cybercrime' || hotspot.threatType === 'Theft') {
      markerIcon = icons.orangeIcon;
    }

    L.marker([hotspot.lat, hotspot.lng], { icon: markerIcon })
      .addTo(map)
      .bindPopup(`
        <strong>Location:</strong> ${hotspot.location}<br>
        <strong>Threat Type:</strong> ${hotspot.threatType}<br>
        <strong>Description:</strong> ${hotspot.description}<br>
        <strong>Reported At:</strong> ${hotspot.timestamp}
      `);
  });
}

// Update live crime map with new data
function updateLiveCrimeMap(map) {
  // Simulate fetching crime data (replace with actual API call)
  const mockCrimeData = {
    crimeType: ['Robbery', 'Assault', 'Cybercrime', 'Theft'][Math.floor(Math.random() * 4)],
    latitude: 20.5937 + (Math.random() * 10 - 5),
    longitude: 78.9629 + (Math.random() * 10 - 5),
    timestamp: new Date().toLocaleTimeString()
  };

  const marker = L.marker([mockCrimeData.latitude, mockCrimeData.longitude])
    .addTo(map)
    .bindPopup(`<strong>Crime Type:</strong> ${mockCrimeData.crimeType}<br><strong>Time:</strong> ${mockCrimeData.timestamp}`)
    .openPopup();

  // Remove old markers after some time
  setTimeout(() => {
    map.removeLayer(marker);
  }, 30000);
}

// Initialize crime log
function initializeCrimeLog() {
  const crimeLog = document.getElementById('crime-log');
  const crimes = [
    { type: 'Suspicious activity detected in Zone 2ðŸŸ ', color: 'orange' },
    { type: 'Armed robbery reported in Zone 3ðŸ”´', color: 'red' },
    { type: 'Assault case logged in Zone 5ðŸ”´', color: 'red' },
    { type: 'Police dispatched to Zone 1ðŸ”µ', color: 'blue' },
    { type: 'Theft reported in Zone 4ðŸ”´', color: 'red' },
    { type: 'Cybercrime reported in Zone 3ðŸŸ ', color: 'orange' }
  ];

  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function addCrimeEntry() {
    const randomCrime = crimes[Math.floor(Math.random() * crimes.length)];

    const entry = document.createElement('div');
    entry.className = 'crime-entry';
    
    entry.innerHTML = `
      <span class="timestamp">[${getCurrentTime()}]</span>
      <i class="fas fa-circle" style="color: ${randomCrime.color}; font-size: 10px;"></i>
      <span>${randomCrime.type}</span>
    `;
    
    crimeLog.prepend(entry);

    if (crimeLog.children.length > 50) {
      crimeLog.removeChild(crimeLog.lastChild);
    }
  }

  // Add initial entries
  for (let i = 0; i < 5; i++) {
    addCrimeEntry();
  }

  // Set up interval for new entries
  return setInterval(addCrimeEntry, 5000);
}

// Update time display
function initializeClock() {
  const timeElement = document.getElementById('timeDisplay');

  function updateTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const day = now.toLocaleString('default', { weekday: 'long' });
    const year = now.getFullYear();
    const month = now.toLocaleString('default', { month: 'long' });
    const dayOfMonth = now.getDate();

    timeElement.textContent = `${hours}:${minutes}:${seconds} | ${dayOfMonth} ${month} ${year} | ${day}`;
  }

  updateTime();
  return setInterval(updateTime, 1000);
}

// Main initialization function
document.addEventListener('DOMContentLoaded', () => {
  // Initialize all components
  const crimeChart = initializeCrimeChart();
  const { liveCrimeMap, nationalCrimeMap } = initializeMaps();
  const icons = createMapIcons();
  
  // Add crime hotspots to national map
  addCrimeHotspots(nationalCrimeMap, icons);
  
  // Set up live crime map updates
  const liveCrimeInterval = setInterval(() => {
    updateLiveCrimeMap(liveCrimeMap);
  }, 5000);
  
  // Initialize crime log
  const crimeLogInterval = initializeCrimeLog();
  
  // Initialize clock
  const clockInterval = initializeClock();

  // Cleanup on page unload (optional)
  window.addEventListener('beforeunload', () => {
    clearInterval(liveCrimeInterval);
    clearInterval(crimeLogInterval);
    clearInterval(clockInterval);
  });
});

// Add this script to your HOME page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search functionality
    initSearch();
    
    function initSearch() {
        const searchInput = document.getElementById('globalSearchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResults = document.getElementById('searchResults');
        
        // Perform search function
        function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm === '') {
                clearSearch();
                return;
            }
            
            // Clear previous results and highlights
            clearHighlights();
            searchResults.innerHTML = '';
            
            // Search through all text content on the page
            const textNodes = getTextNodes(document.body);
            let results = [];
            
            textNodes.forEach(node => {
                const content = node.nodeValue;
                if (content.toLowerCase().includes(searchTerm.toLowerCase())) {
                    const parentElement = getParentElement(node);
                    if (parentElement && isVisible(parentElement)) {
                        results.push({
                            element: parentElement,
                            content: content,
                            matches: findMatches(content, searchTerm)
                        });
                    }
                }
            });
            
            // Display results
            if (results.length > 0) {
                results.forEach(result => {
                    highlightMatches(result.element, result.matches);
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <p>${highlightTextInPreview(result.content, result.matches)}</p>
                    `;
                    resultItem.addEventListener('click', () => {
                        result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add extra highlight to the clicked result
                        result.element.classList.add('search-highlight-focus');
                        setTimeout(() => {
                            result.element.classList.remove('search-highlight-focus');
                        }, 2000);
                    });
                    searchResults.appendChild(resultItem);
                });
                
                // Add clear button
                const clearButton = document.createElement('button');
                clearButton.className = 'clear-search';
                clearButton.textContent = 'Clear Search';
                clearButton.addEventListener('click', clearSearch);
                searchResults.appendChild(clearButton);
                
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="no-results">No results found for "' + searchTerm + '"</div>';
                searchResults.style.display = 'block';
            }
        }
        
        // Helper functions
        function getTextNodes(element) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue.trim() !== '') {
                    textNodes.push(node);
                }
            }
            return textNodes;
        }
        
        function getParentElement(node) {
            let parent = node.parentNode;
            while (parent && parent.nodeType === Node.ELEMENT_NODE) {
                if (parent.tagName !== 'SCRIPT' && parent.tagName !== 'STYLE' && 
                    !parent.classList.contains('search-result-item') && 
                    !parent.classList.contains('search-results')) {
                    return parent;
                }
                parent = parent.parentNode;
            }
            return null;
        }
        
        function isVisible(element) {
            return element.offsetWidth > 0 || element.offsetHeight > 0;
        }
        
        function findMatches(text, searchTerm) {
            const regex = new RegExp(searchTerm, 'gi');
            const matches = [];
            let match;
            while ((match = regex.exec(text)) !== null) {
                matches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0]
                });
            }
            return matches;
        }
        
        function highlightMatches(element, matches) {
            if (!element || matches.length === 0) return;
            
            const content = element.textContent;
            let html = content;
            
            // Process matches from end to start to avoid offset issues
            matches.sort((a, b) => b.start - a.start);
            
            matches.forEach(match => {
                const before = html.substring(0, match.start);
                const highlighted = `<span class="highlight">${html.substring(match.start, match.end)}</span>`;
                const after = html.substring(match.end);
                html = before + highlighted + after;
            });
            
            element.innerHTML = html;
        }
        
        function highlightTextInPreview(text, matches) {
            if (matches.length === 0) return text;
            
            // Show context around the first match
            const firstMatch = matches[0];
            const contextStart = Math.max(0, firstMatch.start - 20);
            const contextEnd = Math.min(text.length, firstMatch.end + 20);
            let preview = text.substring(contextStart, contextEnd);
            
            if (contextStart > 0) preview = '...' + preview;
            if (contextEnd < text.length) preview = preview + '...';
            
            // Highlight all matches in the preview
            matches.forEach(match => {
                const adjustedStart = match.start - contextStart + (contextStart > 0 ? 3 : 0);
                const adjustedEnd = match.end - contextStart + (contextStart > 0 ? 3 : 0);
                
                if (adjustedStart >= 0 && adjustedEnd <= preview.length) {
                    const before = preview.substring(0, adjustedStart);
                    const highlighted = `<span class="highlight">${preview.substring(adjustedStart, adjustedEnd)}</span>`;
                    const after = preview.substring(adjustedEnd);
                    preview = before + highlighted + after;
                }
            });
            
            return preview;
        }
        
        function clearHighlights() {
            document.querySelectorAll('.highlight').forEach(highlight => {
                const parent = highlight.parentNode;
                parent.textContent = parent.textContent;
                parent.normalize();
            });
        }
        
        function clearSearch() {
            clearHighlights();
            searchInput.value = '';
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
        }
        
        // Event listeners
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Close results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.style.display = 'none';
            }
        });
    }
    
    // Add Font Awesome if not already loaded
    if (!document.querySelector('link[href*="font-awesome"]')) {
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(faLink);
    }
    
    // Add additional highlight style
    const style = document.createElement('style');
    style.textContent = `
        .search-highlight-focus {
            animation: highlight-pulse 2s;
        }
        @keyframes highlight-pulse {
            0% { background-color: yellow; }
            100% { background-color: transparent; }
        }
    `;
    document.head.appendChild(style);
});

</script>
</body>
</html>
